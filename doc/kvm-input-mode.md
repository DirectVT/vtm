# Keyboard/Viewport/Mouse VT Protocol

The goal of the `kvm-input-mode` protocol is to make command line interactivity cross-platform.

## Audience

...

## Initialization

```
Set:   ESC [ ? 9001 h
Reset: ESC [ ? 9001 l
```

Note: All values used in this protocol are decimal and zero-based.  
Note: The bracketed paste mode is mandatory.  
Note: This protocol is backwards-compatible with the `win32-input-mode` protocol.

## Input Events

- Keyboard
- Viewport
- Mouse
- Selection
- Clipboard

### Keyboard

The sequence fired after every key press and release. This sequence contains a string generated by a keystroke in the form of a set of code points: `UnicodeChar + Continuing1 + ... + ContinuingN`. A string generated by a keystroke can be fragmented and delivered by multiple consecutive events.

```
ESC [ VirtualKey ; ScanCode ; UnicodeChar ; KeyDown ; CtrlState ; RepeatCount ; C1 ; … ; Cn _
```

Field            | Description
-----------------|--------------------------
`VirtualKey`     | Virtual key code.
`ScanCode`       | Key scan code.
`UnicodeChar`    | First character codepoint.
`KeyDown`        | Key pressed flag: 1 - Pressed, 0 - Released.
`CtrlState`      | Keyboard modifiers state.
`RepeatCount`    | Key repeat count.
`C1`, …, `Cn`    | Continuing character codepoints.

### Viewport

The following sequence is the first one received by the application after `kvm-input-mode` request (a-la mode request acknowledgment). The application can respond with a copy of this message if it needs to enable viewport and mouse tracking.

```
ESC [ # 1 ; CaretX ; CaretY ; WinSizeX ; WinSizeY ; ScrollTop ; ScrollBottom ; ScrollLeft ; ScrollRight ; SelStartX ; SelStartY ; SelEndX ; SelEndY ; SelMode ; CtrlState _
```

#### Viewport tracking

When the terminal window is resized, the viewport is finally changed only after a handshake between the terminal and the application. Successive multiple resizing of the window initiates the same number of handshakes.

Handshake steps:
1. The terminal requests a new size.
2. Application must reply with the same message.
3. The terminal applies the new size and sends the changes.
4. Application must reply with the same message.

Between steps 2 and 4, the application must keep radio silence, as their output may be ignored by the terminal.

```
Terminal:    ESC [ # 0 ; WinSizeX ; WinSizeY _
Application: ESC [ # 0 ; WinSizeX ; WinSizeY _
Terminal:    ESC [ # 1 ; CaretX ; CaretY ; WinSizeX ; WinSizeY ; ScrollTop ; ScrollBottom ; ScrollLeft ; ScrollRight ; SelStartX ; SelStartY ; SelEndX ; SelEndY ; SelMode ; CtrlState _
Application: ESC [ # 1 ; CaretX ; CaretY ; WinSizeX ; WinSizeY ; ScrollTop ; ScrollBottom ; ScrollLeft ; ScrollRight ; SelStartX ; SelStartY ; SelEndX ; SelEndY ; SelMode ; CtrlState _
```

Note that the terminal window resizing always reflows the scrollback, so the viewport size, cursor position, scrollable region margins, and selection coordinates are changed at step 3 of handshake.

Field                                        | Description
---------------------------------------------|------------
`CaretX`<br>`CaretY`                         | Current text cursor position.
`WinSizeX`<br>`WinSizeY`                     | Terminal viewport size.
`ScrollTop`/`Bottom`<br>`ScrollLeft`/`Right` | Scrolling region margins.
`SelStartX`/`Y`<br>`SelEndX`/`Y`             | Coordinates of the text selection start/end.
`SelMode`                                    | Text selection mode: 0 - line-based, 1 - rect-based.
`CtrlState`                                  | Keyboard modifiers state.

### Mouse

This event always fires regardless of whether the mouse tracking mode is active or not. An application MUST ignore this event if a selection mode frag is non-zero, unless it intends to participate in the processing of the selection.

```
ESC [ # 2 ; CaretX ; CaretY ; MouseX ; MouseY ; ButtonState ; VwheelDt ; HwheelDt ; CtrlState ; SelActive _
```

Field                    | Description
-------------------------|--------------------------
`CaretX`<br>`CaretY`     | Current text cursor position.
`MouseX`<br>`MouseY`     | Current mouse cursor position.
`ButtonState`            | Pressed mouse button state.
`VwheelDt`<br>`HwheelDt` | Vertical and horizontal wheel delta.
`CtrlState`              | Keyboard modifiers state.
`SelActive`              | Text selection flag: 0 - Disabled; non-zero - Enabled.

### Selection

The sequence fired after every scrollback text selection changed.

```
ESC [ # 3 ; CaretX ; CaretY ; SelStartX ; SelStartY ; SelEndX ; SelEndY ; SelMode _
```

Field                            | Description
---------------------------------|--------------------------
`CaretX`<br>`CaretY`             | Current text cursor position.
`SelStartX`/`Y`<br>`SelEndX`/`Y` | Coordinates of the text selection start/end.
`SelMode`                        | Text selection mode: 0 - line-based, 1 - rect-based.

### Clipboard

The sequence is used to input a block of unmodified text, mainly for pasted from the clipboard.

```
ESC [ 200 ~   to signify the beginning of pasted text and
ESC [ 201 ~   to signify the end.
```

## Scan Codes

...

## Keyboard Modifiers

The state `CtrlState` of keyboard modifiers is the binary OR of all currently pressed modifiers and enabled modes.

Modifier                                | kvm CtrlState   | win32 CtrlState
----------------------------------------|-----------------|-----------------
<kbd>RightAlt</kbd> or <kbd>AltGr</kbd> | `   1` `0x0001` | `   1`  `0x0001`
<kbd>LeftAlt</kbd>                      | `   2` `0x0002` | `   2`  `0x0002`
<kbd>Alt</kbd>                          | `   3` `0x0003` | `   3`  `0x0002`
<kbd>RightCtrl</kbd>                    | `   4` `0x0004` | `   4`  `0x0004`
<kbd>LeftCtrl</kbd>                     | `   8` `0x0008` | `   8`  `0x0008`
<kbd>Ctrl</kbd>                         | `  12` `0x000C` | `  12`  `0x000C`
<kbd>RightShift</kbd>                   | `2048` `0x0800` | `  16`  `0x0010`
<kbd>LeftShift</kbd>                    | `  16` `0x0010` | `  16`  `0x0010`
<kbd>Shift</kbd>                        | `2064` `0x0810` | `  16`  `0x0010`
NumLock on                              | `  32` `0x0020` | `  32`  `0X0020`
ScrollLock mode on                      | `  64` `0x0040` | `  64`  `0X0040`
CapsLock mode on                        | ` 128` `0x0080` | ` 128`  `0x0080`
Extended key                            | ` 256` `0x0100` | ` 256`  `0x0100`
<kbd>RightWin</kbd>                     | ` 512` `0x0200` |
<kbd>LeftWin</kbd>                      | `1024` `0x0400` |
<kbd>Win</kbd>                          | `1536` `0x0600` |

## Physical Key Detection

Key                           | VirtCode     | ScanCode     | CtrlState    | Note
------------------------------|--------------|--------------|--------------|-------------
<kbd>Esc</kbd>                | ` 27` `0x1B` | `  1` `0x01` |              |
<kbd>Pause</kbd>              | ` 19` `0x13` | ` 69` `0x45` |              |
<kbd>Break</kbd>              | `  3` `0x03` | ` 69` `0x45` |              | Ctrl + Break
<kbd>PrintScreen</kbd>        | ` 44` `0x2C` | ` 55` `0x37` | Extended Key |
<kbd>CapsLock</kbd>           | ` 20` `0x14` | ` 58` `0x3A` |              |
<kbd>NumLock</kbd>            | `144` `0x90` | ` 69` `0x45` |              |
<kbd>ScrollLock</kbd>         | `145` `0x91` | ` 69` `0x45` |              |
<kbd>LeftShift</kbd>          | ` 16` `0x10` | ` 42` `0x2A` |              |
<kbd>RightShift</kbd>         | ` 16` `0x10` | ` 54` `0x36` |              |
<kbd>LeftCtrl</kbd>           | ` 17` `0x11` | ` 29` `0x1D` |              |
<kbd>RightCtrl</kbd>          | ` 17` `0x11` | ` 29` `0x1D` | Extended Key |
<kbd>LeftAlt</kbd>            | ` 18` `0x12` | ` 56` `0x38` |              |
<kbd>RightAlt</kbd>           | ` 18` `0x12` | ` 56` `0x38` | Extended Key |
<kbd>LeftWin</kbd>            | ` 91` `0x5B` | ` 91` `0x5B` | Extended Key |
<kbd>RightWin</kbd>           | ` 92` `0x5C` | ` 92` `0x5C` | Extended Key |
<kbd>Apps</kbd>               | ` 93` `0x5D` | ` 93` `0x5D` | Extended Key |
<kbd>Backspace</kbd>          | `  8` `0x08` | ` 14` `0x0E` |              |
<kbd>Space</kbd>              | ` 32` `0x20` | ` 57` `0x39` |              |
<kbd>Tab</kbd>                | `  9` `0x09` | ` 15` `0x0F` |              |
<kbd>'</kbd>                  | `192` `0xC0` | ` 41` `0x29` |              | Back qoute
<kbd>\</kbd>                  | `220` `0xDC` | ` 43` `0x2B` |              |
<kbd>0</kbd>                  | ` 48` `0x30` | ` 11` `0x0B` |              |
<kbd>1</kbd>                  | ` 49` `0x31` | `  2` `0x02` |              |
<kbd>2</kbd>                  | ` 50` `0x32` | `  3` `0x03` |              |
<kbd>3</kbd>                  | ` 51` `0x33` | `  4` `0x04` |              |
<kbd>4</kbd>                  | ` 52` `0x34` | `  5` `0x05` |              |
<kbd>5</kbd>                  | ` 53` `0x35` | `  6` `0x06` |              |
<kbd>6</kbd>                  | ` 54` `0x36` | `  7` `0x07` |              |
<kbd>7</kbd>                  | ` 55` `0x37` | `  8` `0x08` |              |
<kbd>8</kbd>                  | ` 56` `0x38` | `  9` `0x09` |              |
<kbd>9</kbd>                  | ` 57` `0x39` | ` 10` `0x0A` |              |
<kbd>-</kbd>                  | `189` `0xBD` | ` 12` `0x0C` |              |
<kbd>+</kbd>                  | `187` `0xBB` | ` 13` `0x0D` |              |
<kbd>Enter</kbd>              | ` 13` `0x0D` | ` 28` `0x1C` |              |
<kbd>Numpad Enter</kbd>       | ` 13` `0x0D` | ` 28` `0x1C` | Extended Key |
<kbd>Insert</kbd>             | ` 45` `0x2D` | ` 82` `0x52` | Extended Key |
<kbd>Numpad Insert</kbd>      | ` 45` `0x2D` | ` 82` `0x52` |              |
<kbd>Delete</kbd>             | ` 46` `0x2E` | ` 83` `0x53` | Extended Key |
<kbd>Numpad Delete</kbd>      | ` 46` `0x2E` | ` 83` `0x55` |              |
<kbd>Home</kbd>               | ` 36` `0x24` | ` 71` `0x47` | Extended Key |
<kbd>Numpad Home</kbd>        | ` 36` `0x24` | ` 71` `0x47` |              |
<kbd>End</kbd>                | ` 35` `0x23` | ` 79` `0x4F` | Extended Key |
<kbd>Numpad End</kbd>         | ` 35` `0x23` | ` 79` `0x4F` |              |
<kbd>PageUp</kbd>             | ` 33` `0x21` | ` 73` `0x49` | Extended Key |
<kbd>Numpad PageUp</kbd>      | ` 33` `0x21` | ` 73` `0x49` |              |
<kbd>PageDown</kbd>           | ` 34` `0x22` | ` 81` `0x51` | Extended Key |
<kbd>Numpad PageDown</kbd>    | ` 34` `0x22` | ` 81` `0x51` |              |
<kbd>Left Arrow</kbd>         | ` 37` `0x25` | ` 75` `0x4B` | Extended Key |
<kbd>Numpad Left Arrow</kbd>  | ` 37` `0x25` | ` 75` `0x4B` |              |
<kbd>Up Arrow</kbd>           | ` 38` `0x26` | ` 72` `0x48` | Extended Key |
<kbd>Numpad Up Arrow</kbd>    | ` 38` `0x26` | ` 72` `0x48` |              |
<kbd>Right Arrow</kbd>        | ` 39` `0x27` | ` 77` `0x4D` | Extended Key |
<kbd>Numpad Right Arrow</kbd> | ` 39` `0x27` | ` 77` `0x4D` |              |
<kbd>Down Arrow</kbd>         | ` 40` `0x28` | ` 80` `0x50` | Extended Key |
<kbd>Numpad Down Arrow</kbd>  | ` 40` `0x28` | ` 80` `0x50` |              |
<kbd>Select</kbd>             | ` 41` `0x29` |              |              |
<kbd>Numpad 0</kbd>           | ` 96` `0x60` | ` 82` `0x52` | NumLock On   |
<kbd>Numpad 1</kbd>           | ` 97` `0x61` | ` 79` `0x4F` | NumLock On   |
<kbd>Numpad 2</kbd>           | ` 98` `0x62` | ` 80` `0x50` | NumLock On   |
<kbd>Numpad 3</kbd>           | ` 99` `0x63` | ` 81` `0x51` | NumLock On   |
<kbd>Numpad 4</kbd>           | `100` `0x64` | ` 75` `0x4B` | NumLock On   |
<kbd>Numpad 5</kbd>           | `101` `0x65` | ` 76` `0x4C` | NumLock On   |
<kbd>Numpad 6</kbd>           | `102` `0x66` | ` 77` `0x4D` | NumLock On   |
<kbd>Numpad 7</kbd>           | `103` `0x67` | ` 71` `0x47` | NumLock On   |
<kbd>Numpad 8</kbd>           | `104` `0x68` | ` 72` `0x48` | NumLock On   |
<kbd>Numpad 9</kbd>           | `105` `0x69` | ` 73` `0x49` | NumLock On   |
<kbd>Numpad Clear</kbd>       | ` 12` `0x0C` | ` 76` `0x4C` |              | Numpad 5 with NumLock off
<kbd>Numpad *</kbd>           | `106` `0x6A` |              |              |
<kbd>Numpad +</kbd>           | `107` `0x6B` |              |              |
<kbd>Numpad Separator</kbd>   | `108` `0x6C` |              |              |
<kbd>Numpad -</kbd>           | `109` `0x6D` |              |              |
<kbd>Numpad .</kbd>           | `110` `0x6E` |              | NumLock On   |
<kbd>Numpad /</kbd>           | `111` `0x6F` |              | Extended Key |
<kbd>/</kbd>                  | `191` `0xBF` |              |              |
<kbd>,</kbd>                  | `188` `0xBC` |              |              | Comma
<kbd>.</kbd>                  | `190` `0xBE` |              |              | Period
<kbd>[</kbd>                  | `219` `0xDB` |              |              |
<kbd>]</kbd>                  | `221` `0xDD` |              |              |
<kbd>;</kbd>                  | `186` `0xBA` |              |              |
<kbd>'</kbd>                  | `222` `0xDE` |              |              | Single qoute
<kbd>F1</kbd>                 | `112` `0x70` | ` 59` `0x3B` |              |
<kbd>F2</kbd>                 | `113` `0x71` | ` 61` `0x3C` |              |
<kbd>F3</kbd>                 | `114` `0x72` | ` 62` `0x3D` |              |
<kbd>F4</kbd>                 | `115` `0x73` | ` 63` `0x3E` |              |
<kbd>F5</kbd>                 | `116` `0x74` | ` 64` `0x3F` |              |
<kbd>F6</kbd>                 | `117` `0x75` | ` 65` `0x40` |              |
<kbd>F7</kbd>                 | `118` `0x76` | ` 66` `0x41` |              |
<kbd>F8</kbd>                 | `119` `0x77` | ` 67` `0x42` |              |
<kbd>F9</kbd>                 | `120` `0x78` | ` 68` `0x43` |              |
<kbd>F10</kbd>                | `121` `0x79` | ` 69` `0x44` |              |
<kbd>F11</kbd>                | `122` `0x7A` | ` 87` `0x57` |              |
<kbd>F12</kbd>                | `123` `0x7B` | ` 88` `0x5B` |              |
<kbd>F13</kbd>                | `124` `0x7C` |              |              |
<kbd>F14</kbd>                | `125` `0x7D` |              |              |
<kbd>F15</kbd>                | `126` `0x7E` |              |              |
<kbd>F16</kbd>                | `127` `0x7F` |              |              |
<kbd>F17</kbd>                | `128` `0x80` |              |              |
<kbd>F18</kbd>                | `129` `0x81` |              |              |
<kbd>F19</kbd>                | `130` `0x82` |              |              |
<kbd>F20</kbd>                | `131` `0x83` |              |              |
<kbd>F21</kbd>                | `132` `0x84` |              |              |
<kbd>F22</kbd>                | `133` `0x85` |              |              |
<kbd>F23</kbd>                | `134` `0x86` |              |              |
<kbd>F24</kbd>                | `135` `0x87` |              |              |
<kbd>A</kbd>                  | ` 65` `0x41` |              |              |
<kbd>B</kbd>                  | ` 66` `0x42` |              |              |
<kbd>C</kbd>                  | ` 67` `0x43` |              |              |
<kbd>D</kbd>                  | ` 68` `0x44` |              |              |
<kbd>E</kbd>                  | ` 69` `0x45` |              |              |
<kbd>F</kbd>                  | ` 70` `0x46` |              |              |
<kbd>G</kbd>                  | ` 71` `0x47` |              |              |
<kbd>H</kbd>                  | ` 72` `0x48` |              |              |
<kbd>I</kbd>                  | ` 73` `0x49` |              |              |
<kbd>J</kbd>                  | ` 74` `0x4A` |              |              |
<kbd>K</kbd>                  | ` 75` `0x4B` |              |              |
<kbd>L</kbd>                  | ` 76` `0x4C` |              |              |
<kbd>M</kbd>                  | ` 77` `0x4D` |              |              |
<kbd>N</kbd>                  | ` 78` `0x4E` |              |              |
<kbd>O</kbd>                  | ` 79` `0x4F` |              |              |
<kbd>P</kbd>                  | ` 80` `0x50` |              |              |
<kbd>Q</kbd>                  | ` 81` `0x51` |              |              |
<kbd>R</kbd>                  | ` 82` `0x52` |              |              |
<kbd>S</kbd>                  | ` 83` `0x53` |              |              |
<kbd>T</kbd>                  | ` 84` `0x54` |              |              |
<kbd>U</kbd>                  | ` 85` `0x55` |              |              |
<kbd>V</kbd>                  | ` 86` `0x56` |              |              |
<kbd>W</kbd>                  | ` 87` `0x57` |              |              |
<kbd>X</kbd>                  | ` 88` `0x58` |              |              |
<kbd>Y</kbd>                  | ` 89` `0x59` |              |              |
<kbd>Z</kbd>                  | ` 90` `0x5A` |              |              |
<kbd>Sleep</kbd>              | ` 95` `0x5F` |              | Extended Key |
<kbd>Calculator</kbd>         | `183` `0xB7` |              | Extended Key | App2
<kbd>WWW</kbd>                | `172` `0xAC` |              | Extended Key |
<kbd>Mail</kbd>               | `184` `0x48` |              | Extended Key |
<kbd>Media</kbd>              | `181` `0xB5` |              | Extended Key |
<kbd>Media Vol Mute</kbd>     | `173` `0xAD` |              | Extended Key |
<kbd>Media Vol Down</kbd>     | `174` `0xAE` |              | Extended Key |
<kbd>Media Vol Up</kbd>       | `175` `0xAF` |              | Extended Key |
<kbd>Media Next</kbd>         | `176` `0xB0` |              | Extended Key |
<kbd>Media Prev</kbd>         | `177` `0xB1` |              | Extended Key |
<kbd>Media Stop</kbd>         | `178` `0xB2` |              | Extended Key |
<kbd>Media Play/Pause</kbd>   | `179` `0xB3` |              | Extended Key |
<kbd>Browser Back</kbd>       | `166` `0xA6` |              | Extended Key |
<kbd>Browser Forward</kbd>    | `167` `0xA7` |              | Extended Key |
<kbd>Browser Refresh</kbd>    | `168` `0xA8` |              | Extended Key |
<kbd>Browser Stop</kbd>       | `169` `0xA9` |              | Extended Key |
<kbd>Browser Search</kbd>     | `170` `0xAA` |              | Extended Key |
<kbd>Browser Favorites</kbd>  | `171` `0xAB` |              | Extended Key |
<kbd>Browser Home</kbd>       | `172` `0xAC` |              | Extended Key |

...

## Mouse Buttons

...