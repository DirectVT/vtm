# Keyboard/Viewport/Mouse VT Protocol

The goal of the `kvm-input-mode` protocol is to make command line interactivity cross-platform.

- All values used in this protocol are decimal and zero-based.
- The bracketed paste mode is mandatory.
- This protocol is backwards-compatible with the `win32-input-mode` protocol.

## Audience

...

## Initialization

```
Set:   ESC [ ? 9001 h
Reset: ESC [ ? 9001 l
```

## Input Events

- Keyboard
  ```
  ESC [ KeyCode ; ScanCode ; UniCode ; KeyState ; CtrlState ; RepeatCount ; C1 ; … ; Cn _
  ```
- Viewport
  ```
  ESC [ # 1 ; WinSizeX ; WinSizeY ; CtrlState ; CaretX ; CaretY ; ScrollTop ; ScrollBottom ; ScrollLeft ; ScrollRight ; SelStartX ; SelStartY ; SelEndX ; SelEndY ; SelMode _
  ```
- Mouse
  ```
  ESC [ # 2 ; CaretX ; CaretY ; SelStartX ; SelStartY ; SelEndX ; SelEndY ; SelMode _
  ```

### Keyboard

```
ESC [ KeyCode ; ScanCode ; UniCode ; KeyState ; CtrlState ; RepeatCount ; C1 ; … ; Cn _
```

This sequence fired after every key press and key release. Event data can contain a string generated by a keystroke as a set of codepoints: `UniCode + C1 + ... + Cn`. The string can be fragmented and delivered by multiple consecutive events.

For compatibility with the `win32-input-mode` protocol, the non-BMP codepoints could be split into surrogate halves (two 16-bit code units) and sent unit-by-unit in successive events.

Field            | Description
-----------------|--------------------------
`KeyCode`        | Key code.
`ScanCode`       | Scan code.
`UniCode`        | First codepoint of the generated string.
`KeyState`       | Key state flag: 1 - Pressed, 0 - Released.
`CtrlState`      | Keyboard modifiers state.
`RepeatCount`    | Key repeat count.
`C1`, …, `Cn`    | Continuing codepoints of the generated string.

### Viewport

```
ESC [ # 1 ; WinSizeX ; WinSizeY ; CtrlState ; CaretX ; CaretY ; ScrollTop ; ScrollBottom ; ScrollLeft ; ScrollRight ; SelStartX ; SelStartY ; SelEndX ; SelEndY ; SelMode _
```

This sequence is the first one received by the application after `kvm-input-mode` request (a-la mode request acknowledgment). The application can respond with a copy of this message if it needs to enable viewport and mouse tracking.

#### Viewport tracking

When the terminal window is resized, the viewport is finally changed only after a handshake between the terminal and the application. Successive multiple resizing of the window initiates the same number of handshakes.

Handshake steps:
1. The terminal requests a new size, omitting all other parameters.
2. Application must reply with the same message.
3. The terminal applies the new size and sends the changes.

```
Terminal:    ESC [ # 1 ; WinSizeX ; WinSizeY _
Application: ESC [ # 1 ; WinSizeX ; WinSizeY _
Terminal:    ESC [ # 1 ; WinSizeX ; WinSizeY ; CtrlState ; CaretX ; CaretY ; ScrollTop ; ScrollBottom ; ScrollLeft ; ScrollRight ; SelStartX ; SelStartY ; SelEndX ; SelEndY ; SelMode _
```

Note that the terminal window resizing always reflows the scrollback, so the viewport size, cursor position, scrolling regions, and selection coordinates are subject to change during step 3. In case the aplication's output is anchored to the current cursor position or uses scrolling regions, the application should wait after step 2 for the updated values before continuing to output.

Field                                        | Description
---------------------------------------------|------------
`WinSizeX`<br>`WinSizeY`                     | Terminal viewport size.
`CaretX`<br>`CaretY`                         | Current text cursor position.
`ScrollTop`/`Bottom`<br>`ScrollLeft`/`Right` | Scrolling region margins.
`SelStartX`/`Y`<br>`SelEndX`/`Y`             | Coordinates of the text selection start/end.
`SelMode`                                    | Text selection mode: 0 - line-based, 1 - rect-based.
`CtrlState`                                  | Keyboard modifiers state.

### Mouse

```
ESC [ # 2 ; CaretX ; CaretY ; SelStartX ; SelStartY ; SelEndX ; SelEndY ; SelMode _
```

This sequence fired after every scrollback text selection changed. In the case of using the mouse for selection, a single left click is treated as a special case of selection when the start and end are the same (empty selection).

Field                            | Description
---------------------------------|--------------------------
`CaretX`<br>`CaretY`             | Current text cursor position.
`SelStartX`/`Y`<br>`SelEndX`/`Y` | Coordinates of the text selection start/end.
`SelMode`                        | Text selection mode: 0 - line-based, 1 - rect-based.

## Conventions

### Scan Codes

`ScanCode`s are usually useful for applications that need to know which key is pressed, regardless of the current keyboard layout. For example, the WASD (W = Up, A = Left, S = Down, D = Right) keys for games, which ensure a consistent key formation across QWERTY, AZERTY or Dvorak keyboard layouts.

Scan codes for the keys on a standard 104-key keyboard:

```
┌────┐  ┌────╥────╥────╥────┐  ┌────╥────╥────╥────┐  ┌────╥────╥────╥────┐  ┌────╥────╥────┐
| 01 │  | 3B ║ 3C ║ 3D ║ 3E |  | 3F ║ 40 ║ 41 ║ 42 |  | 43 ║ 44 ║ 57 ║ 58 |  | 37 ║ 46 ║ 45 |
└────┘  └────╨────╨────╨────┘  └────╨────╨────╨────┘  └────╨────╨────╨────┘  └────╨────╨────┘
┌────╥────╥────╥────╥────╥────╥────╥────╥────╥────╥────╥────╥────╥────────┐  ┌────╥────╥────┐  ┌────╥────╥────╥────┐
| 29 ║ 02 ║ 03 ║ 04 ║ 05 ║ 06 ║ 07 ║ 08 ║ 09 ║ 0A ║ 0B ║ 0C ║ 0D ║     0E |  | 52 ║ 47 ║ 49 |  | 45 ║ 35 ║ 37 ║ 4A |
╞════╩═╦══╩═╦══╩═╦══╩═╦══╩═╦══╩═╦══╩═╦══╩═╦══╩═╦══╩═╦══╩═╦══╩═╦══╩═╦══════╡  ╞════╬════╬════╡  ╞════╬════╬════╬════╡
| 0F   ║ 10 ║ 11 ║ 12 ║ 13 ║ 14 ║ 15 ║ 16 ║ 17 ║ 18 ║ 19 ║ 1A ║ 1B ║   2B |  | 53 ║ 4F ║ 51 |  | 47 ║ 48 ║ 49 ║    |
╞══════╩╦═══╩╦═══╩╦═══╩╦═══╩╦═══╩╦═══╩╦═══╩╦═══╩╦═══╩╦═══╩╦═══╩╦═══╩══════╡  └────╨────╨────┘  ╞════╬════╬════╣ 4E |
| 3A    ║ 1E ║ 1F ║ 20 ║ 21 ║ 22 ║ 23 ║ 24 ║ 25 ║ 26 ║ 27 ║ 28 ║       1C |                    | 4B ║ 4C ║ 4D ║    |
╞═══════╩═╦══╩═╦══╩═╦══╩═╦══╩═╦══╩═╦══╩═╦══╩═╦══╩═╦══╩═╦══╩═╦══╩══════════╡       ┌────┐       ╞════╬════╬════╬════╡
| 2A      ║ 2C ║ 2D ║ 2E ║ 2F ║ 30 ║ 31 ║ 32 ║ 33 ║ 34 ║ 35 ║          36 |       | 48 |       | 4F ║ 50 ║ 51 ║    |
╞══════╦══╩═╦══╩═══╦╩════╩════╩════╩════╩════╩════╩╦═══╩╦═══╩╦═════╦══════╡  ┌────┼────┼────┐  ╞════╩════╬════╣ 1C |
| 1D   ║ 5B ║ 38   ║               39              ║ 38 ║ 5C ║  5D ║   1D |  | 4B | 50 | 4D |  |      52 ║ 53 ║    |
└──────╨────╨──────╨───────────────────────────────╨────╨────╨─────╨──────┘  └────┴────┴────┘  └─────────╨────╨────┘
```

### Keyboard Modifiers

The state `CtrlState` of keyboard modifiers is the binary OR of all currently pressed modifiers and enabled modes.

Modifier                                | kvm CtrlState   | win32 CtrlState
----------------------------------------|-----------------|-----------------
<kbd>RightAlt</kbd> or <kbd>AltGr</kbd> | `   1` `0x0001` | `   1`  `0x0001`
<kbd>LeftAlt</kbd>                      | `   2` `0x0002` | `   2`  `0x0002`
<kbd>Alt</kbd>                          | `   3` `0x0003` | `   3`  `0x0002`
<kbd>RightCtrl</kbd>                    | `   4` `0x0004` | `   4`  `0x0004`
<kbd>LeftCtrl</kbd>                     | `   8` `0x0008` | `   8`  `0x0008`
<kbd>Ctrl</kbd>                         | `  12` `0x000C` | `  12`  `0x000C`
<kbd>RightShift</kbd>                   | `2048` `0x0800` | `  16`  `0x0010`
<kbd>LeftShift</kbd>                    | `  16` `0x0010` | `  16`  `0x0010`
<kbd>Shift</kbd>                        | `2064` `0x0810` | `  16`  `0x0010`
<kbd>NumLock Mode</kbd>                 | `  32` `0x0020` | `  32`  `0X0020`
<kbd>ScrollLock Mode</kbd>              | `  64` `0x0040` | `  64`  `0X0040`
<kbd>CapsLock Mode</kbd>                | ` 128` `0x0080` | ` 128`  `0x0080`
<kbd>Extended Key</kbd>                 | ` 256` `0x0100` | ` 256`  `0x0100`
<kbd>RightWin</kbd>                     | ` 512` `0x0200` |
<kbd>LeftWin</kbd>                      | `1024` `0x0400` |
<kbd>Win</kbd>                          | `1536` `0x0600` |

### Physical Keys

Each key is one-to-one mapped to three parameters: `KeyCode`, `ScanCode`, and `CtrlState` flag. The string generated by keystroke is not included as it depends on the national keyboard layout and language.

Physical Key                  | KeyCode      | ScanCode     | CtrlState    | Notes
------------------------------|--------------|--------------|--------------|-------------
<kbd>Esc</kbd>                | ` 27` `0x1B` | `  1` `0x01` |              |
<kbd>Pause</kbd>              | ` 19` `0x13` | ` 69` `0x45` |              |
<kbd>Break</kbd>              | `  3` `0x03` | ` 69` `0x45` |              | Ctrl + Pause
<kbd>SysRq</kbd>              | ` 44` `0x2C` | ` 84` `0x54` |              | Alt + PrintScreen
<kbd>PrintScreen</kbd>        | ` 44` `0x2C` | ` 55` `0x37` |`Extended Key`|
<kbd>CapsLock</kbd>           | ` 20` `0x14` | ` 58` `0x3A` |              |
<kbd>NumLock</kbd>            | `144` `0x90` | ` 69` `0x45` |              |
<kbd>ScrollLock</kbd>         | `145` `0x91` | ` 69` `0x45` |              |
<kbd>LeftShift</kbd>          | ` 16` `0x10` | ` 42` `0x2A` |              |
<kbd>RightShift</kbd>         | ` 16` `0x10` | ` 54` `0x36` |              |
<kbd>LeftCtrl</kbd>           | ` 17` `0x11` | ` 29` `0x1D` |              |
<kbd>RightCtrl</kbd>          | ` 17` `0x11` | ` 29` `0x1D` |`Extended Key`|
<kbd>LeftAlt</kbd>            | ` 18` `0x12` | ` 56` `0x38` |              |
<kbd>RightAlt</kbd>           | ` 18` `0x12` | ` 56` `0x38` |`Extended Key`|
<kbd>LeftWin</kbd>            | ` 91` `0x5B` | ` 91` `0x5B` |`Extended Key`|
<kbd>RightWin</kbd>           | ` 92` `0x5C` | ` 92` `0x5C` |`Extended Key`|
<kbd>Apps</kbd>               | ` 93` `0x5D` | ` 93` `0x5D` |`Extended Key`|
<kbd>Backspace</kbd>          | `  8` `0x08` | ` 14` `0x0E` |              |
<kbd>Space</kbd>              | ` 32` `0x20` | ` 57` `0x39` |              |
<kbd>Tab</kbd>                | `  9` `0x09` | ` 15` `0x0F` |              |
<kbd>'</kbd>                  | `192` `0xC0` | ` 41` `0x29` |              | Back qoute
<kbd>\</kbd>                  | `220` `0xDC` | ` 43` `0x2B` |              |
<kbd>0</kbd>                  | ` 48` `0x30` | ` 11` `0x0B` |              |
<kbd>1</kbd>                  | ` 49` `0x31` | `  2` `0x02` |              |
<kbd>2</kbd>                  | ` 50` `0x32` | `  3` `0x03` |              |
<kbd>3</kbd>                  | ` 51` `0x33` | `  4` `0x04` |              |
<kbd>4</kbd>                  | ` 52` `0x34` | `  5` `0x05` |              |
<kbd>5</kbd>                  | ` 53` `0x35` | `  6` `0x06` |              |
<kbd>6</kbd>                  | ` 54` `0x36` | `  7` `0x07` |              |
<kbd>7</kbd>                  | ` 55` `0x37` | `  8` `0x08` |              |
<kbd>8</kbd>                  | ` 56` `0x38` | `  9` `0x09` |              |
<kbd>9</kbd>                  | ` 57` `0x39` | ` 10` `0x0A` |              |
<kbd>-</kbd>                  | `189` `0xBD` | ` 12` `0x0C` |              |
<kbd>+</kbd>                  | `187` `0xBB` | ` 13` `0x0D` |              |
<kbd>Enter</kbd>              | ` 13` `0x0D` | ` 28` `0x1C` |              |
<kbd>Numpad Enter</kbd>       | ` 13` `0x0D` | ` 28` `0x1C` |`Extended Key`|
<kbd>Insert</kbd>             | ` 45` `0x2D` | ` 82` `0x52` |`Extended Key`|
<kbd>Numpad Insert</kbd>      | ` 45` `0x2D` | ` 82` `0x52` |              |
<kbd>Delete</kbd>             | ` 46` `0x2E` | ` 83` `0x53` |`Extended Key`|
<kbd>Numpad Delete</kbd>      | ` 46` `0x2E` | ` 83` `0x55` |              |
<kbd>Home</kbd>               | ` 36` `0x24` | ` 71` `0x47` |`Extended Key`|
<kbd>Numpad Home</kbd>        | ` 36` `0x24` | ` 71` `0x47` |              |
<kbd>End</kbd>                | ` 35` `0x23` | ` 79` `0x4F` |`Extended Key`|
<kbd>Numpad End</kbd>         | ` 35` `0x23` | ` 79` `0x4F` |              |
<kbd>PageUp</kbd>             | ` 33` `0x21` | ` 73` `0x49` |`Extended Key`|
<kbd>Numpad PageUp</kbd>      | ` 33` `0x21` | ` 73` `0x49` |              |
<kbd>PageDown</kbd>           | ` 34` `0x22` | ` 81` `0x51` |`Extended Key`|
<kbd>Numpad PageDown</kbd>    | ` 34` `0x22` | ` 81` `0x51` |              |
<kbd>Left Arrow</kbd>         | ` 37` `0x25` | ` 75` `0x4B` |`Extended Key`|
<kbd>Numpad Left Arrow</kbd>  | ` 37` `0x25` | ` 75` `0x4B` |              |
<kbd>Up Arrow</kbd>           | ` 38` `0x26` | ` 72` `0x48` |`Extended Key`|
<kbd>Numpad Up Arrow</kbd>    | ` 38` `0x26` | ` 72` `0x48` |              |
<kbd>Right Arrow</kbd>        | ` 39` `0x27` | ` 77` `0x4D` |`Extended Key`|
<kbd>Numpad Right Arrow</kbd> | ` 39` `0x27` | ` 77` `0x4D` |              |
<kbd>Down Arrow</kbd>         | ` 40` `0x28` | ` 80` `0x50` |`Extended Key`|
<kbd>Numpad Down Arrow</kbd>  | ` 40` `0x28` | ` 80` `0x50` |              |
<kbd>Select</kbd>             | ` 41` `0x29` |              |              |
<kbd>Numpad 0</kbd>           | ` 96` `0x60` | ` 82` `0x52` |`NumLock Mode`|
<kbd>Numpad 1</kbd>           | ` 97` `0x61` | ` 79` `0x4F` |`NumLock Mode`|
<kbd>Numpad 2</kbd>           | ` 98` `0x62` | ` 80` `0x50` |`NumLock Mode`|
<kbd>Numpad 3</kbd>           | ` 99` `0x63` | ` 81` `0x51` |`NumLock Mode`|
<kbd>Numpad 4</kbd>           | `100` `0x64` | ` 75` `0x4B` |`NumLock Mode`|
<kbd>Numpad 5</kbd>           | `101` `0x65` | ` 76` `0x4C` |`NumLock Mode`|
<kbd>Numpad 6</kbd>           | `102` `0x66` | ` 77` `0x4D` |`NumLock Mode`|
<kbd>Numpad 7</kbd>           | `103` `0x67` | ` 71` `0x47` |`NumLock Mode`|
<kbd>Numpad 8</kbd>           | `104` `0x68` | ` 72` `0x48` |`NumLock Mode`|
<kbd>Numpad 9</kbd>           | `105` `0x69` | ` 73` `0x49` |`NumLock Mode`|
<kbd>Numpad Clear</kbd>       | ` 12` `0x0C` | ` 76` `0x4C` |              | Numpad 5 key when NumLock Mode off
<kbd>Numpad *</kbd>           | `106` `0x6A` |              |              |
<kbd>Numpad +</kbd>           | `107` `0x6B` |              |              |
<kbd>Numpad Separator</kbd>   | `108` `0x6C` |              |              |
<kbd>Numpad -</kbd>           | `109` `0x6D` |              |              |
<kbd>Numpad .</kbd>           | `110` `0x6E` |              |`NumLock Mode`|
<kbd>Numpad /</kbd>           | `111` `0x6F` |              |`Extended Key`|
<kbd>/</kbd>                  | `191` `0xBF` |              |              |
<kbd>,</kbd>                  | `188` `0xBC` |              |              | Comma
<kbd>.</kbd>                  | `190` `0xBE` |              |              | Period
<kbd>[</kbd>                  | `219` `0xDB` |              |              |
<kbd>]</kbd>                  | `221` `0xDD` |              |              |
<kbd>;</kbd>                  | `186` `0xBA` |              |              |
<kbd>'</kbd>                  | `222` `0xDE` |              |              | Single qoute
<kbd>F1</kbd>                 | `112` `0x70` | ` 59` `0x3B` |              |
<kbd>F2</kbd>                 | `113` `0x71` | ` 61` `0x3C` |              |
<kbd>F3</kbd>                 | `114` `0x72` | ` 62` `0x3D` |              |
<kbd>F4</kbd>                 | `115` `0x73` | ` 63` `0x3E` |              |
<kbd>F5</kbd>                 | `116` `0x74` | ` 64` `0x3F` |              |
<kbd>F6</kbd>                 | `117` `0x75` | ` 65` `0x40` |              |
<kbd>F7</kbd>                 | `118` `0x76` | ` 66` `0x41` |              |
<kbd>F8</kbd>                 | `119` `0x77` | ` 67` `0x42` |              |
<kbd>F9</kbd>                 | `120` `0x78` | ` 68` `0x43` |              |
<kbd>F10</kbd>                | `121` `0x79` | ` 69` `0x44` |              |
<kbd>F11</kbd>                | `122` `0x7A` | ` 87` `0x57` |              |
<kbd>F12</kbd>                | `123` `0x7B` | ` 88` `0x5B` |              |
<kbd>F13</kbd>                | `124` `0x7C` |              |              |
<kbd>F14</kbd>                | `125` `0x7D` |              |              |
<kbd>F15</kbd>                | `126` `0x7E` |              |              |
<kbd>F16</kbd>                | `127` `0x7F` |              |              |
<kbd>F17</kbd>                | `128` `0x80` |              |              |
<kbd>F18</kbd>                | `129` `0x81` |              |              |
<kbd>F19</kbd>                | `130` `0x82` |              |              |
<kbd>F20</kbd>                | `131` `0x83` |              |              |
<kbd>F21</kbd>                | `132` `0x84` |              |              |
<kbd>F22</kbd>                | `133` `0x85` |              |              |
<kbd>F23</kbd>                | `134` `0x86` |              |              |
<kbd>F24</kbd>                | `135` `0x87` |              |              |
<kbd>A</kbd>                  | ` 65` `0x41` |              |              |
<kbd>B</kbd>                  | ` 66` `0x42` |              |              |
<kbd>C</kbd>                  | ` 67` `0x43` |              |              |
<kbd>D</kbd>                  | ` 68` `0x44` |              |              |
<kbd>E</kbd>                  | ` 69` `0x45` |              |              |
<kbd>F</kbd>                  | ` 70` `0x46` |              |              |
<kbd>G</kbd>                  | ` 71` `0x47` |              |              |
<kbd>H</kbd>                  | ` 72` `0x48` |              |              |
<kbd>I</kbd>                  | ` 73` `0x49` |              |              |
<kbd>J</kbd>                  | ` 74` `0x4A` |              |              |
<kbd>K</kbd>                  | ` 75` `0x4B` |              |              |
<kbd>L</kbd>                  | ` 76` `0x4C` |              |              |
<kbd>M</kbd>                  | ` 77` `0x4D` |              |              |
<kbd>N</kbd>                  | ` 78` `0x4E` |              |              |
<kbd>O</kbd>                  | ` 79` `0x4F` |              |              |
<kbd>P</kbd>                  | ` 80` `0x50` |              |              |
<kbd>Q</kbd>                  | ` 81` `0x51` |              |              |
<kbd>R</kbd>                  | ` 82` `0x52` |              |              |
<kbd>S</kbd>                  | ` 83` `0x53` |              |              |
<kbd>T</kbd>                  | ` 84` `0x54` |              |              |
<kbd>U</kbd>                  | ` 85` `0x55` |              |              |
<kbd>V</kbd>                  | ` 86` `0x56` |              |              |
<kbd>W</kbd>                  | ` 87` `0x57` |              |              |
<kbd>X</kbd>                  | ` 88` `0x58` |              |              |
<kbd>Y</kbd>                  | ` 89` `0x59` |              |              |
<kbd>Z</kbd>                  | ` 90` `0x5A` |              |              |
<kbd>Sleep</kbd>              | ` 95` `0x5F` |              |`Extended Key`|
<kbd>Calculator</kbd>         | `183` `0xB7` |              |`Extended Key`| App2
<kbd>WWW</kbd>                | `172` `0xAC` |              |`Extended Key`|
<kbd>Mail</kbd>               | `184` `0x48` |              |`Extended Key`|
<kbd>Media</kbd>              | `181` `0xB5` |              |`Extended Key`|
<kbd>Media Vol Mute</kbd>     | `173` `0xAD` |              |`Extended Key`|
<kbd>Media Vol Down</kbd>     | `174` `0xAE` |              |`Extended Key`|
<kbd>Media Vol Up</kbd>       | `175` `0xAF` |              |`Extended Key`|
<kbd>Media Next</kbd>         | `176` `0xB0` |              |`Extended Key`|
<kbd>Media Prev</kbd>         | `177` `0xB1` |              |`Extended Key`|
<kbd>Media Stop</kbd>         | `178` `0xB2` |              |`Extended Key`|
<kbd>Media Play/Pause</kbd>   | `179` `0xB3` |              |`Extended Key`|
<kbd>Browser Back</kbd>       | `166` `0xA6` |              |`Extended Key`|
<kbd>Browser Forward</kbd>    | `167` `0xA7` |              |`Extended Key`|
<kbd>Browser Refresh</kbd>    | `168` `0xA8` |              |`Extended Key`|
<kbd>Browser Stop</kbd>       | `169` `0xA9` |              |`Extended Key`|
<kbd>Browser Search</kbd>     | `170` `0xAA` |              |`Extended Key`|
<kbd>Browser Favorites</kbd>  | `171` `0xAB` |              |`Extended Key`|
<kbd>Browser Home</kbd>       | `172` `0xAC` |              |`Extended Key`|

## Usage Examples

### C++20

```c++
#include <iostream>

int main()
{
    std::cout << "test" << '\n';
}
```

### Python

```python
#!/bin/python

while True:
    print('test\n')
```

### PowerShell

```powershell
while ($True)
{
   "test";
}
```